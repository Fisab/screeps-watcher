# Screeps

## watcher
Сервис для обновления.
Получает такую информацию как:
- Все о комнате (структуры, крипы, ... - `room:shard0`)
- Архитектуру комнаты (TODO)
- Использование CPU пользователя (`user:cpu`)
- Донатные ресурсы (`user:resources`)

### Примеры данных:
Аккуратно тут так же присутствует мета-информация `mongodb`
Мое это в основе:
- `tick` - тик игры (для комнат он прилетает с `ws`), для остальных типов я запрашиваю отдельно
- `meta` - мета ендпоинта (сам придумал, ниже объяснение)
- `meta_info` - так же ниже
- `message` - то что прилетает с сервера по `ws`

! Прошу заметить, что данные хранятся не всегда, в `mongo` выставлен индекс на удаление после [N выставлен](config.tmp.yml#11) (сейчас он равен 600 секунд)

То самое объяснение:
```
Было:
room:shard0/W16N58 
user:55d1c722bbc786b40f59ecc1/resources
Стало:
{meta}:{meta_info}/{topic}
```
---
#### user:resources
```json
{
    "_id":
    {
        "$oid": "613cfbfabb5de3182b107230"
    },
    "_expire":
    {
        "$date": "2021-09-11T18:56:58.665Z"
    },
    "tick": 45094796,
    "meta": "user",
    "meta_info": "55d1c722bbc786b40f59ecc1",
    "message":
    {
        "pixel": 0,
        "cpuUnlock": 0,
        "credits": 0
    }
}
```
---
#### user:cpu
```json
{
    "_id":
    {
        "$oid": "613cffd040be5b3b2b85217d"
    },
    "_expire":
    {
        "$date": "2021-09-11T19:13:20.301Z"
    },
    "tick": 45094970,
    "meta": "user",
    "meta_info": "55d1c722bbc786b40f59ecc1",
    "message":
    {
        "cpu": 0,
        "memory": 514837
    }
}
```
---
#### room:shard0

Слишком громоздкая тема, поэтому вот [ссылка](docs/example_room:shard0.json)

---
#### room_terrain

Слишком громоздкая тема, поэтому вот [ссылка](docs/example_room_terrain.json)

##### room_subscribe
```json
{
    "_id":
    {
        "$oid": "613d0896df029836497b0b40"
    },
    "room_name": "W16N58"
}
```
P.S. номер шарда подтянется с конфига сервиса
В реальном времени `watcher` подпишется, или отпишется от получения данных по комнате (с некоторой задержкой не большей 5 минут по идее)

### Как watcher узнает о каких комнатах получать данные?

Это вшито в коллекцию с названием `rooms_subscribe`

### Что еще?

Еще есть [файлик](migration_mongo.py) миграции, правда хз зачем он, так как в коде и так обрабатываю создание новых коллекции (разве что для бд)

! Важно что в [config.yml](config.tmp.yml) описаны не все нужные коллекции, лучше посмотреть миграцию